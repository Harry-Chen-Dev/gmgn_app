import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../bloc/auth/auth_bloc.dart';
import '../../bloc/auth/auth_event.dart';
import '../../bloc/auth/auth_state.dart';

class SettingsPage extends StatelessWidget {
  const SettingsPage({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      appBar: AppBar(
        backgroundColor: Colors.white,
        elevation: 0,
        leading: IconButton(
          icon: const Icon(Icons.arrow_back, color: Colors.black),
          onPressed: () => Navigator.pop(context),
        ),
        title: const Text(
          'ËÆæÁΩÆ',
          style: TextStyle(
            color: Colors.black,
            fontSize: 18,
            fontWeight: FontWeight.w600,
          ),
        ),
        actions: [
          IconButton(
            icon: const Icon(Icons.refresh, color: Colors.black),
            onPressed: () {
              // TODO: Âà∑Êñ∞Áî®Êà∑‰ø°ÊÅØ
            },
          ),
        ],
      ),
      body: BlocBuilder<AuthBloc, AuthState>(
        builder: (context, state) {
          if (state is AuthAuthenticated) {
            return _buildAuthenticatedContent(context, state);
          } else {
            return _buildUnauthenticatedContent(context);
          }
        },
      ),
    );
  }

  Widget _buildAuthenticatedContent(
      BuildContext context, AuthAuthenticated state) {
    return Column(
      children: [
        Expanded(
          child: SingleChildScrollView(
            child: Column(
              children: [
                // Áî®Êà∑‰ø°ÊÅØÂå∫Âüü
                _buildUserInfoSection(context, state),
                const SizedBox(height: 20),

                // ËÆæÁΩÆÈÄâÈ°πÂàóË°®
                _buildSettingsOptions(context),
              ],
            ),
          ),
        ),

        // Â∫ïÈÉ®Êñ≠ÂºÄËøûÊé•ÊåâÈíÆ
        _buildDisconnectButton(context),
      ],
    );
  }

  Widget _buildUnauthenticatedContent(BuildContext context) {
    return const Center(
      child: Text(
        'ËØ∑ÂÖàÁôªÂΩï',
        style: TextStyle(
          fontSize: 16,
          color: Color(0xFF666666),
        ),
      ),
    );
  }

  Widget _buildUserInfoSection(BuildContext context, AuthAuthenticated state) {
    return Container(
      padding: const EdgeInsets.all(20),
      child: Row(
        children: [
          // Áî®Êà∑Â§¥ÂÉè
          Container(
            width: 60,
            height: 60,
            decoration: BoxDecoration(
              color: const Color(0xFF00C851),
              borderRadius: BorderRadius.circular(12),
            ),
            child: ClipRRect(
              borderRadius: BorderRadius.circular(12),
              child: Image.asset(
                'assets/images/gmgn_avatar.png',
                width: 60,
                height: 60,
                fit: BoxFit.cover,
                errorBuilder: (context, error, stackTrace) {
                  return Container(
                    width: 60,
                    height: 60,
                    decoration: BoxDecoration(
                      color: const Color(0xFF00C851),
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: const Icon(
                      Icons.person,
                      color: Colors.white,
                      size: 30,
                    ),
                  );
                },
              ),
            ),
          ),
          const SizedBox(width: 16),

          // Áî®Êà∑‰ø°ÊÅØ
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Text(
                      state.user.walletAddress,
                      style: const TextStyle(
                        fontSize: 18,
                        fontWeight: FontWeight.w600,
                        color: Colors.black,
                      ),
                    ),
                    const SizedBox(width: 8),
                    const Icon(
                      Icons.edit,
                      size: 16,
                      color: Color(0xFF999999),
                    ),
                  ],
                ),
                const SizedBox(height: 8),
                Row(
                  children: [
                    const Text(
                      'Èí±ÂåÖÂú∞ÂùÄ: ',
                      style: TextStyle(
                        fontSize: 14,
                        color: Color(0xFF999999),
                      ),
                    ),
                    Text(
                      state.user.walletAddress,
                      style: const TextStyle(
                        fontSize: 14,
                        color: Color(0xFF999999),
                      ),
                    ),
                    const SizedBox(width: 8),
                    const Icon(
                      Icons.copy,
                      size: 14,
                      color: Color(0xFF999999),
                    ),
                    const SizedBox(width: 8),
                    Container(
                      width: 16,
                      height: 16,
                      decoration: const BoxDecoration(
                        color: Color(0xFFF0F0F0),
                        shape: BoxShape.circle,
                      ),
                      child: const Icon(
                        Icons.remove,
                        size: 12,
                        color: Color(0xFF999999),
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 4),
                Row(
                  children: [
                    const Text(
                      'UID: ',
                      style: TextStyle(
                        fontSize: 14,
                        color: Color(0xFF999999),
                      ),
                    ),
                    Text(
                      state.user.id.padLeft(8, '0'),
                      style: const TextStyle(
                        fontSize: 14,
                        color: Color(0xFF999999),
                      ),
                    ),
                    const SizedBox(width: 8),
                    const Icon(
                      Icons.copy,
                      size: 14,
                      color: Color(0xFF999999),
                    ),
                  ],
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildSettingsOptions(BuildContext context) {
    final options = [
      {
        'icon': Icons.card_giftcard,
        'title': 'ÈÇÄËØ∑Â•ΩÂèã',
        'subtitle': 'ÈÇÄËØ∑Â•ΩÂèãËµö‰Ω£Èáë',
        'trailing': 'üí∞',
        'hasArrow': true,
      },
      {
        'icon': Icons.security,
        'title': 'ÂÆâÂÖ®ËÆæÁΩÆ',
        'hasArrow': true,
      },
      {
        'icon': Icons.account_balance_wallet,
        'title': 'Èí±ÂåÖÁÆ°ÁêÜ',
        'hasArrow': true,
      },
      {
        'icon': Icons.tune,
        'title': 'ÂÅèÂ•ΩËÆæÁΩÆ',
        'hasArrow': true,
      },
      {
        'icon': Icons.notifications,
        'title': 'Ê∂àÊÅØËÆæÁΩÆ',
        'trailing': 'Â∑≤ÂÖ≥Èó≠',
        'hasArrow': true,
      },
      {
        'icon': Icons.help_outline,
        'title': 'Â∏ÆÂä©‰∏éÂèçÈ¶à',
        'hasArrow': true,
      },
      {
        'icon': Icons.info_outline,
        'title': 'ÂÖ≥‰∫éÊàë‰ª¨',
        'trailing': '1.1.1.21(1010121)',
        'hasArrow': true,
      },
    ];

    return Container(
      margin: const EdgeInsets.symmetric(horizontal: 16),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(12),
      ),
      child: Column(
        children: options
            .map((option) => _buildSettingItem(
                  context,
                  icon: option['icon'] as IconData,
                  title: option['title'] as String,
                  subtitle: option['subtitle'] as String?,
                  trailing: option['trailing'] as String?,
                  hasArrow: option['hasArrow'] as bool? ?? false,
                ))
            .toList(),
      ),
    );
  }

  Widget _buildSettingItem(
    BuildContext context, {
    required IconData icon,
    required String title,
    String? subtitle,
    String? trailing,
    bool hasArrow = false,
  }) {
    return InkWell(
      onTap: () {
        _handleSettingTap(context, title);
      },
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 16),
        child: Row(
          children: [
            Icon(
              icon,
              size: 24,
              color: const Color(0xFF333333),
            ),
            const SizedBox(width: 16),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    title,
                    style: const TextStyle(
                      fontSize: 16,
                      fontWeight: FontWeight.w500,
                      color: Colors.black,
                    ),
                  ),
                  if (subtitle != null) ...[
                    const SizedBox(height: 4),
                    Text(
                      subtitle,
                      style: const TextStyle(
                        fontSize: 14,
                        color: Color(0xFF999999),
                      ),
                    ),
                  ],
                ],
              ),
            ),
            if (trailing != null) ...[
              Text(
                trailing,
                style: const TextStyle(
                  fontSize: 14,
                  color: Color(0xFF999999),
                ),
              ),
              const SizedBox(width: 8),
            ],
            if (hasArrow)
              const Icon(
                Icons.chevron_right,
                size: 20,
                color: Color(0xFF999999),
              ),
          ],
        ),
      ),
    );
  }

  Widget _buildDisconnectButton(BuildContext context) {
    return Container(
      width: double.infinity,
      margin: const EdgeInsets.all(20),
      child: ElevatedButton(
        onPressed: () => _showLogoutDialog(context),
        style: ElevatedButton.styleFrom(
          backgroundColor: Colors.white,
          foregroundColor: Colors.red,
          elevation: 0,
          side: const BorderSide(color: Color(0xFFE5E5E5)),
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(12),
          ),
          padding: const EdgeInsets.symmetric(vertical: 16),
        ),
        child: const Text(
          'Êñ≠ÂºÄËøûÊé•',
          style: TextStyle(
            fontSize: 16,
            fontWeight: FontWeight.w500,
          ),
        ),
      ),
    );
  }

  void _handleSettingTap(BuildContext context, String title) {
    // Â§ÑÁêÜÂêÑ‰∏™ËÆæÁΩÆÈ°πÁöÑÁÇπÂáª‰∫ã‰ª∂
    switch (title) {
      case 'ÈÇÄËØ∑Â•ΩÂèã':
        _showInviteFriends(context);
        break;
      case 'ÂÆâÂÖ®ËÆæÁΩÆ':
        _showSecuritySettings(context);
        break;
      case 'Èí±ÂåÖÁÆ°ÁêÜ':
        _showWalletManagement(context);
        break;
      case 'ÂÅèÂ•ΩËÆæÁΩÆ':
        _showPreferences(context);
        break;
      case 'Ê∂àÊÅØËÆæÁΩÆ':
        _showNotificationSettings(context);
        break;
      case 'Â∏ÆÂä©‰∏éÂèçÈ¶à':
        _showHelpAndFeedback(context);
        break;
      case 'ÂÖ≥‰∫éÊàë‰ª¨':
        _showAboutUs(context);
        break;
    }
  }

  void _showInviteFriends(BuildContext context) {
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(content: Text('ÈÇÄËØ∑Â•ΩÂèãÂäüËÉΩÂºÄÂèë‰∏≠...')),
    );
  }

  void _showSecuritySettings(BuildContext context) {
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(content: Text('ÂÆâÂÖ®ËÆæÁΩÆÂäüËÉΩÂºÄÂèë‰∏≠...')),
    );
  }

  void _showWalletManagement(BuildContext context) {
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(content: Text('Èí±ÂåÖÁÆ°ÁêÜÂäüËÉΩÂºÄÂèë‰∏≠...')),
    );
  }

  void _showPreferences(BuildContext context) {
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(content: Text('ÂÅèÂ•ΩËÆæÁΩÆÂäüËÉΩÂºÄÂèë‰∏≠...')),
    );
  }

  void _showNotificationSettings(BuildContext context) {
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(content: Text('Ê∂àÊÅØËÆæÁΩÆÂäüËÉΩÂºÄÂèë‰∏≠...')),
    );
  }

  void _showHelpAndFeedback(BuildContext context) {
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(content: Text('Â∏ÆÂä©‰∏éÂèçÈ¶àÂäüËÉΩÂºÄÂèë‰∏≠...')),
    );
  }

  void _showAboutUs(BuildContext context) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('ÂÖ≥‰∫éÊàë‰ª¨'),
        content: const Text(
          'GMGN App\n'
          'ÁâàÊú¨: 1.1.1.21(1010121)\n'
          'Êõ¥Âø´ÂèëÁé∞ÔºåÁßíÁ∫ß‰∫§Êòì\n'
          'Âø´ÈÄüÈìæ‰∏äÊìç‰ΩúÔºå‰∏ÄÈîÆ‰∫§ÊòìÔºõËá™Âä®Ê≠¢ÁõàÊ≠¢Êçü„ÄÇ',
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('Á°ÆÂÆö'),
          ),
        ],
      ),
    );
  }

  void _showLogoutDialog(BuildContext context) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('Á°ÆËÆ§ÈÄÄÂá∫'),
        content: const Text('Á°ÆÂÆöË¶ÅÊñ≠ÂºÄËøûÊé•Âπ∂ÈÄÄÂá∫ÁôªÂΩïÂêóÔºü'),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text(
              'ÂèñÊ∂à',
              style: TextStyle(color: Color(0xFF999999)),
            ),
          ),
          TextButton(
            onPressed: () {
              Navigator.pop(context); // ÂÖ≥Èó≠ÂØπËØùÊ°Ü
              Navigator.pop(context); // ËøîÂõû‰∏ä‰∏ÄÈ°µ
              context.read<AuthBloc>().add(const AuthLogoutRequested());
            },
            child: const Text(
              'Á°ÆÂÆö',
              style: TextStyle(color: Colors.red),
            ),
          ),
        ],
      ),
    );
  }
}
